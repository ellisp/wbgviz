<script>
window.initializeCodeFolding = function(show) {

  // handlers for show-all and hide all
  $("#rmd-show-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('show');
    });
  });
  $("#rmd-hide-all-code").click(function() {
    $('div.r-code-collapse').each(function() {
      $(this).collapse('hide');
    });
  });

  // index for unique code element ids
  var currentIndex = 1;

  // select all R code blocks
  var rCodeBlocks = $('pre.r');
  rCodeBlocks.each(function() {

    // create a collapsable div to wrap the code in
    var div = $('<div class="collapse r-code-collapse"></div>');
    if (show)
      div.addClass('in');
    var id = 'rcode-643E0F36' + currentIndex++;
    div.attr('id', id);
    $(this).before(div);
    $(this).detach().appendTo(div);

    // add a show code button right above

  var showCodeButton = $('<button type="button" class="dropdown-toggle btn btn-default btn-xs code-folding-btn pull-right">Source <span class="caret"></span></button>');
    showCodeButton
        .attr('data-toggle', 'dropdown')
        .attr('aria-haspopup', true)
        .attr('aria-expanded', false)
        .css('margin-bottom', '4px');

    var buttonRow = $('<div class="row"></div>');
    var buttonGroup = $('<div class="btn-group col-md-12 pull-right"</div>');

    var showCodeText = $('<a><span>'+(show ? 'Hide Code' : 'Show code')+'</span></a>');
    var itemCode = $('<li></li>');
    itemCode.append(showCodeText);
    itemCode
      .attr('data-toggle', 'collapse')
      .attr('data-target', '#' + id)
      .attr('aria-expanded', true)
      .attr('aria-controls', id)

    var dataLink = div.nextUntil('pre.r','p').find('a:contains("Download data")');
    //console.log("link:");
    //console.log(dataLink);
    var itemData = $('<li></li>');
    dataLink.detach().appendTo(itemData);

    var dropDownMenu = $('<ul class="dropdown-menu" style="min-width: 50px">')

    dropDownMenu.append(itemCode);
    dropDownMenu.append(itemData);

    buttonGroup.append(showCodeButton);
    buttonGroup.append(dropDownMenu);
    buttonRow.append(buttonGroup);

    div.before(buttonRow);

    // update state of button on show/hide
    div.on('hidden.bs.collapse', function () {
      showCodeText.text('Show code');
    });
    div.on('show.bs.collapse', function () {
      showCodeText.text('Hide code');
    });
  });

}
</script>